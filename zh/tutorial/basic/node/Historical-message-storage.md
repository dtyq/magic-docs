# 历史消息存储节点
## 什么是历史消息存储节点？
历史消息存储节点是 Magic Flow 工作流中用于记录和保存对话消息的功能节点。它就像一个记忆存储器，能够将指定的文本信息保存到对话的历史记录中，以便后续查询和使用。这些存储的消息可以在后续的交互中被检索出来，为智能体提供对话记忆能力。

**图片说明：**

顶部是消息类型选择区域，目前支持文本、图片、文件卡片类型消息；底部是消息内容输入区域，支持使用"@"添加变量，实现动态内容存储。
![历史消息存储节点](/static/img/Historical-message-storage.png)

## 为什么需要历史消息存储节点？
在智能对话系统中，记忆和上下文管理是提供连贯交互体验的关键。历史消息存储节点能够帮助您：
1. **构建智能体记忆**：让智能体"记住"重要的信息，不需要用户重复提供
2. **保存中间结果**：将工作流中的关键数据和中间结果存储起来，后续流程可以引用
3. **维护对话连贯性**：通过存储上下文信息，确保对话的连续性和上下文感知
4. **创建用户画像**：记录用户提供的关键信息，逐步构建用户画像，提供个性化体验
## 适用场景
### 场景一：用户信息收集与记忆
在用户首次提供个人信息（如姓名、偏好等）后，可以使用历史消息存储节点记录这些信息。之后的对话中，系统可以直接使用这些记忆，避免重复询问，提升用户体验。
### 场景二：多轮对话记忆管理
在复杂的多轮对话场景中，某些关键信息需要跨多个对话回合使用。通过历史消息存储节点，可以有选择地保存重要内容，而不仅仅依赖自动记忆的近期消息。
### 场景三：工作流程状态记录
在处理工单、审批等流程场景中，可以使用历史消息存储节点记录每个环节的状态和结果，形成完整的处理记录，方便后续查询和追踪。
## 节点参数说明
### 输入参数
**历史消息存储节点的主要输入参数是消息内容，包括：**
|参数名称|说明|是否必填|默认值|
|---|---|---|---|
|消息类型|目前支持文本、图片、文件卡片类型消息|是|文本|
|消息内容|需要存储的文本信息，支持引用变量|是|无|

### 输出内容
历史消息存储节点没有标准的输出参数，它的主要作用是将内容写入到系统的历史消息记录中。
## 使用说明
### 基本配置步骤
1. **添加节点**：在工作流编辑器中拖入历史消息存储节点
2. **选择消息类型**：在消息类型下拉菜单中选择"文本"
3. **编写消息内容**：在消息内容输入框中输入需要存储的文本
    1. 可以直接输入固定文本，如"用户偏好已记录"
    2. 也可以通过"@"符号引用变量，如"用户喜好：@user_preference"
4. **连接节点**：将历史消息存储节点与前序节点（如条件分支或代码执行节点）和后续节点连接起来
### 进阶技巧
1. **组合变量使用**：消息内容支持多个变量组合，可以构建结构化的记忆内容
2. **使用条件过滤**：配合条件分支节点，只在特定条件满足时存储信息
3. **格式化存储内容**：使用格式良好的文本模板，便于后续检索和处理
## 注意事项
### 存储数量限制
- **适量存储**：不要存储过多不必要的信息，这可能会导致历史记录过于冗长
- **关注重点**：只存储对后续交互有价值的关键信息，提高存储效率
### 内容安全
- **敏感信息处理**：避免存储用户隐私和敏感信息，如密码、详细联系方式等
- **合规使用**：确保存储内容符合数据隐私相关规定
### 内容格式
- **结构清晰**：设计结构化的存储格式，便于后续检索和理解
- **长度控制**：过长的内容可能在后续查询时不易处理，建议控制合理长度
## 常见问题
### 存储的内容在后续流程中找不到
**解决方案**：
1. 确认工作流执行顺序是否正确，存储节点必须在查询节点之前执行
2. 检查历史消息查询节点的时间范围设置，确保包含了存储消息的时间点
3. 增加历史消息查询节点的最大条数设置，确保能够覆盖到存储的消息
### 存储的变量内容不正确
**解决方案**：
1. 检查变量引用是否正确，确保使用了正确的变量名
2. 验证前序节点是否成功输出了预期的变量值
3. 使用代码执行节点打印变量内容进行调试，确认变量在工作流中的传递是否正确
## 常见搭配节点
|节点类型|搭配说明|
|---|---|
|历史消息查询节点|存储和查询配合使用，实现完整的记忆管理|
|大模型调用节点|将存储的历史信息提供给大模型，增强上下文理解|
|条件分支节点|根据条件决定是否存储特定信息|
|代码执行节点|处理和格式化需要存储的|